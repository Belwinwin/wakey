<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Owner Dashboard - Driver Drowsiness Detection</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body {
            padding-top: 70px;
            background-color: #f5f5f5;
        }
        .dashboard-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .stat-card {
            text-align: center;
            padding: 15px;
        }
        .stat-card .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #0d6efd;
        }
        .stat-card .stat {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .stat-card .label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .alert-severity-high {
            border-left: 5px solid #dc3545;
        }
        .alert-severity-medium {
            border-left: 5px solid #fd7e14;
        }
        .alert-severity-low {
            border-left: 5px solid #0dcaf0;
        }
        .risk-level {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .risk-low {
            background-color: #198754;
        }
        .risk-medium {
            background-color: #ffc107;
        }
        .risk-high {
            background-color: #fd7e14;
        }
        .risk-critical {
            background-color: #dc3545;
        }
        .suspended-row {
            background-color: #f8d7da;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">Driver Drowsiness Detection</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/owner/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/register_driver">Register Driver</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/view_alerts">View Alerts</a>
                    </li>
                    <!-- Removed Manage Driver Modules nav item -->
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> {{ session.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/logout">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4">
            <div class="col">
                <h2>Fleet Owner Dashboard</h2>
                <p class="text-muted">Monitor your drivers' drowsiness status and alerts</p>
            </div>
            <div class="col-auto">
                <a href="/register_driver" class="btn btn-primary">
                    <i class="bi bi-person-plus"></i> Register New Driver
                </a>
            </div>
        </div>

        <div class="row mb-4">
            <!-- Statistics Cards -->
            <div class="col-md-3">
                <div class="dashboard-card stat-card">
                    <div class="icon">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div class="stat" id="totalDrivers">{{ drivers|length }}</div>
                    <div class="label">Total Drivers</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card stat-card">
                    <div class="icon">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <div class="stat" id="alertCount">...</div>
                    <div class="label">Total Alerts</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card stat-card">
                    <div class="icon">
                        <i class="bi bi-activity"></i>
                    </div>
                    <div class="stat" id="activeDrivers">...</div>
                    <div class="label">Active Drivers</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card stat-card">
                    <div class="icon">
                        <i class="bi bi-shield-exclamation"></i>
                    </div>
                    <div class="stat" id="highRiskCount">...</div>
                    <div class="label">High Risk Drivers</div>
                </div>
            </div>
        </div>

        <!-- Driver List -->
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-3">Your Drivers</h3>
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createVehicleModal">
                    <i class="bi bi-truck"></i> Manage Vehicles
                </button>
            </div>
            {% if drivers %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Risk Level</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for driver in drivers %}
                                <tr id="driver-row-{{ driver.id }}" class="{% if driver.suspended %}suspended-row{% endif %}">
                                    <td>{{ driver.username }}</td>
                                    <td>{{ driver.email }}</td>
                                    <td>
                                        <span class="driver-risk-level" data-driver-id="{{ driver.id }}">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="driver-status" data-driver-id="{{ driver.id }}">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="/view_driver/{{ driver.id }}" class="btn btn-primary">
                                                <i class="bi bi-eye"></i> View
                                            </a>
                                            <a href="/driver_alerts/{{ driver.id }}" class="btn btn-info">
                                                <i class="bi bi-bell"></i> Alerts
                                            </a>
                                            <button class="btn btn-secondary update-ref-btn" 
                                                data-bs-toggle="modal"
                                                data-bs-target="#updateReferenceModal"
                                                data-driver-id="{{ driver.id }}"
                                                data-driver-name="{{ driver.username }}">
                                                <i class="bi bi-camera"></i> Update Photo
                                            </button>
                                            <button class="btn {% if driver.suspended %}btn-success{% else %}btn-danger{% endif %} suspension-btn" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#suspensionModal" 
                                                data-driver-id="{{ driver.id }}" 
                                                data-driver-name="{{ driver.username }}"
                                                data-action="{% if driver.suspended %}unsuspend{% else %}suspend{% endif %}">
                                                <i class="bi {% if driver.suspended %}bi-play-fill{% else %}bi-pause-fill{% endif %}"></i> 
                                                {% if driver.suspended %}Unsuspend{% else %}Suspend{% endif %}
                                            </button>
                                            <button class="btn btn-outline-success assign-vehicle-btn"
                                                data-driver-id="{{ driver.id }}"
                                                data-driver-name="{{ driver.username }}"
                                                data-bs-toggle="modal"
                                                data-bs-target="#assignVehicleModal">
                                                <i class="bi bi-truck"></i> Assign Vehicle
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> You don't have any drivers registered yet. 
                    <a href="/register_driver" class="alert-link">Register a driver</a> to get started.
                </div>
            {% endif %}
        </div>

        <!-- Pie Chart: Driver Activity -->
        <div class="dashboard-card mb-4">
            <h4 class="mb-3">Driver Activity Overview</h4>
            <canvas id="driverActivityPie" width="300" height="180"></canvas>
            <div class="d-flex justify-content-center gap-4 mt-3">
                <span class="badge bg-success">
                    Active: <span id="activeCountLabel">0</span>
                </span>
                <span class="badge bg-secondary">
                    Inactive: <span id="inactiveCountLabel">0</span>
                </span>
            </div>
            <div class="text-muted small mt-2">Shows the proportion of active vs inactive drivers</div>
        </div>

        <!-- Recent Alerts -->
        <!--
        <div class="dashboard-card mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Recent Alerts</h3>
                <a href="/view_alerts" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            
            <div id="recent-alerts">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading recent alerts...</p>
                </div>
            </div>
        </div>
        -->
    </div>

    <!-- Add Suspension Modal -->
    <div class="modal fade" id="suspensionModal" tabindex="-1" aria-labelledby="suspensionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="suspensionModalLabel">Suspend Driver</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="suspensionForm">
                        <input type="hidden" id="suspensionDriverId" name="driver_id">
                        <input type="hidden" id="suspensionAction" name="action">
                        
                        <div class="mb-3">
                            <label for="suspensionMessage" class="form-label">Message to Driver:</label>
                            <textarea class="form-control" id="suspensionMessage" name="message" rows="3" placeholder="Enter message to notify the driver"></textarea>
                            <div class="form-text">This message will be displayed to the driver and read aloud.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmSuspension">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Update Reference Image Modal -->
    <div class="modal fade" id="updateReferenceModal" tabindex="-1" aria-labelledby="updateReferenceModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="updateReferenceModalLabel">Update Reference Photo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="referenceImageForm">
              <input type="hidden" id="referenceDriverId" name="driver_id">
              <div class="row">
                <div class="col-md-8">
                  <div class="position-relative mb-3" style="height: 320px;">
                    <video id="webcam" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover; border:1px solid #ccc;"></video>
                    <canvas id="captureCanvas" style="display: none;"></canvas>
                    <div id="captureCountdown" class="position-absolute top-50 start-50 translate-middle" style="font-size: 4rem; color: white; text-shadow: 2px 2px 5px black; display: none;">3</div>
                  </div>
                  <div class="d-flex justify-content-between">
                    <button type="button" id="startCameraBtn" class="btn btn-primary">Start Camera</button>
                    <button type="button" id="capturePhotoBtn" class="btn btn-success" disabled>Capture Photo</button>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Preview:</label>
                    <div class="border rounded p-2 bg-light text-center">
                      <img id="photoPreview" src="https://placehold.co/600x400.png" class="img-fluid" style="max-height: 250px; object-fit: contain;">
                    </div>
                  </div>
                  <div class="form-text mb-3">
                    <ul>
                      <li>Ensure proper lighting</li>
                      <li>Keep face centered</li>
                      <li>Maintain neutral expression</li>
                    </ul>
                  </div>
                </div>
              </div>
              <input type="hidden" id="imageData" name="image_data">
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveRefImageBtn" disabled>Save Photo</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Assign Vehicle Modal -->
    <div class="modal fade" id="assignVehicleModal" tabindex="-1" aria-labelledby="assignVehicleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="assignVehicleForm">
            <div class="modal-header">
              <h5 class="modal-title" id="assignVehicleModalLabel">Assign Vehicle</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="assignDriverId" name="driver_id">
              <div class="mb-3">
                <label for="vehicleSelect" class="form-label">Vehicle</label>
                <select class="form-select" id="vehicleSelect" name="vehicle_id" required>
                  <option value="">Select vehicle</option>
                  <!-- Populated by JS -->
                </select>
              </div>
              <div class="mb-3">
                <label for="startTime" class="form-label">Start Time</label>
                <input type="datetime-local" class="form-control" id="startTime" name="start_time" required>
              </div>
              <div class="mb-3">
                <label for="endTime" class="form-label">End Time</label>
                <input type="datetime-local" class="form-control" id="endTime" name="end_time" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Assign</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Create Vehicle Modal -->
    <div class="modal fade" id="createVehicleModal" tabindex="-1" aria-labelledby="createVehicleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="createVehicleForm">
            <div class="modal-header">
              <h5 class="modal-title" id="createVehicleModalLabel">Create Vehicle</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="vehicleName" class="form-label">Vehicle Name</label>
                <input type="text" class="form-control" id="vehicleName" name="vehicle_name" required>
              </div>
              <div class="mb-3">
                <label for="licensePlate" class="form-label">License Plate</label>
                <input type="text" class="form-control" id="licensePlate" name="license_plate" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Create Vehicle</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Request notification permission on page load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        // Global array to track notified alert IDs
        let notifiedAlerts = [];
        // Function to update dashboard information
        function updateDashboardInfo() {
            // Get alert count
            fetch('/api/alert_count')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('alertCount').textContent = data.count;
                })
                .catch(error => {
                    console.error('Error fetching alert count:', error);
                    document.getElementById('alertCount').textContent = 'Error';
                });
            
            // Get recent alerts
            fetch('/api/recent_alerts')
                .then(response => response.json())
                .then(data => {
                    const alertsContainer = document.getElementById('recent-alerts');
                    if (!alertsContainer) return; // Prevent JS error if element is missing

                    if (data.alerts && data.alerts.length > 0) {
                        let alertsHTML = '';
                        
                        data.alerts.forEach(alert => {
                            const alertDate = new Date(alert.timestamp);
                            const formattedDate = alertDate.toLocaleString();
                            
                            let severityClass = '';
                            if (alert.alert_type === 'microsleep') {
                                severityClass = 'alert-severity-high';
                            } else if (alert.alert_type === 'drowsiness') {
                                severityClass = 'alert-severity-medium';
                            } else {
                                severityClass = 'alert-severity-low';
                            }
                            
                            alertsHTML += `
                                <div class="card mb-2 ${severityClass}">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-0">${alert.username || 'Unknown Driver'}</h6>
                                                <span class="text-muted small">${formattedDate}</span>
                                            </div>
                                            <span class="badge bg-danger">${alert.alert_type}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                            // Trigger browser notification for drowsiness or yawning if not already notified
                            if ((alert.alert_type === 'drowsiness' || alert.alert_type === 'yawning') 
                                    && !notifiedAlerts.includes(alert.id)) {
                                if (Notification.permission === "granted") {
                                    new Notification("Driver Alert", {
                                        body: `${alert.username || "Unknown Driver"} reported ${alert.alert_type} at ${formattedDate}`
                                    });
                                    notifiedAlerts.push(alert.id);
                                }
                            }
                        });
                        
                        alertsContainer.innerHTML = alertsHTML;
                    } else {
                        alertsContainer.innerHTML = `
                            <div class="alert alert-info">
                                No recent alerts found.
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching recent alerts:', error);
                    const alertsContainer = document.getElementById('recent-alerts');
                    if (alertsContainer) {
                        alertsContainer.innerHTML = `
                            <div class="alert alert-danger">
                                Error loading alerts. Please try refreshing the page.
                            </div>
                        `;
                    }
                });
            
            // Update driver risk levels and status
            const driverRiskElements = document.querySelectorAll('.driver-risk-level');
            const driverStatusElements = document.querySelectorAll('.driver-status');
            
            let activeCount = 0;
            let highRiskCount = 0;
            
            // Create arrays to track all fetch promises
            const riskPromises = [];
            const statusPromises = [];
            
            // Process each driver - collect risk level data
            driverRiskElements.forEach(element => {
                const driverId = element.getAttribute('data-driver-id');
                
                // Get risk level
                const riskPromise = fetch(`/api/risk_level/${driverId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const riskLevel = data.risk_level;
                            const riskLabel = data.risk_label;
                            let riskClass = '';
                            
                            if (riskLevel === 0) riskClass = 'risk-low';
                            else if (riskLevel === 1) riskClass = 'risk-medium';
                            else if (riskLevel === 2) riskClass = 'risk-high';
                            else if (riskLevel === 3) riskClass = 'risk-critical';
                            
                            // Update the risk indicator
                            element.innerHTML = `<span class="risk-level ${riskClass}"></span>${riskLabel}`;
                            
                            // Count high risk drivers
                            if (riskLevel >= 2) {
                                highRiskCount++;
                            }
                        } else {
                            element.textContent = 'Unknown';
                        }
                    })
                    .catch(error => {
                        console.error(`Error fetching risk level for driver ${driverId}:`, error);
                        element.textContent = 'Error';
                    });
                    
                riskPromises.push(riskPromise);
            });
            
            // Process each driver status
            driverStatusElements.forEach(element => {
                const driverId = element.getAttribute('data-driver-id');
                
                // Get status
                const statusPromise = fetch(`/api/driver_module_status/${driverId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (data.is_active) {
                                element.innerHTML = '<span class="badge bg-success">Active</span>';
                                activeCount++;
                            } else {
                                element.innerHTML = '<span class="badge bg-secondary">Inactive</span>';
                                // Set risk to low immediately if inactive
                                const riskElem = document.querySelector(`.driver-risk-level[data-driver-id="${driverId}"]`);
                                if (riskElem) {
                                    riskElem.innerHTML = '<span class="risk-level risk-low"></span>Low';
                                }
                            }
                        } else {
                            element.textContent = 'Unknown';
                        }
                    })
                    .catch(error => {
                        console.error(`Error fetching status for driver ${driverId}:`, error);
                        element.textContent = 'Error';
                    });
                    
                statusPromises.push(statusPromise);
            });
            
            // Wait for all promises to complete before updating counters
            Promise.all([...riskPromises, ...statusPromises]).then(() => {
                // Update counters once all requests are complete
                document.getElementById('activeDrivers').textContent = activeCount;
                document.getElementById('highRiskCount').textContent = highRiskCount;
                // Update pie chart
                updateDriverActivityPie(activeCount, {{ drivers|length }});
            });
        }

        // Update dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateDashboardInfo();
            
            // Update dashboard every 30 seconds
            setInterval(updateDashboardInfo, 30000);
        });

        // Handle suspension modal
        document.addEventListener('DOMContentLoaded', function() {
            const suspensionModal = document.getElementById('suspensionModal');
            const suspensionButtons = document.querySelectorAll('.suspension-btn');
            const confirmSuspensionButton = document.getElementById('confirmSuspension');
            
            suspensionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const driverId = this.getAttribute('data-driver-id');
                    const driverName = this.getAttribute('data-driver-name');
                    const action = this.getAttribute('data-action');
                    
                    document.getElementById('suspensionDriverId').value = driverId;
                    document.getElementById('suspensionAction').value = action;
                    
                    const modalTitle = document.getElementById('suspensionModalLabel');
                    if (action === 'suspend') {
                        modalTitle.textContent = `Suspend Driver: ${driverName}`;
                        document.getElementById('suspensionMessage').placeholder = "Enter reason for suspension...";
                        confirmSuspensionButton.classList.remove('btn-success');
                        confirmSuspensionButton.classList.add('btn-danger');
                        confirmSuspensionButton.textContent = 'Suspend Driver';
                    } else {
                        modalTitle.textContent = `Unsuspend Driver: ${driverName}`;
                        document.getElementById('suspensionMessage').placeholder = "Enter message for unsuspension...";
                        confirmSuspensionButton.classList.remove('btn-danger');
                        confirmSuspensionButton.classList.add('btn-success');
                        confirmSuspensionButton.textContent = 'Unsuspend Driver';
                    }
                });
            });
            
            confirmSuspensionButton.addEventListener('click', function() {
                const driverId = document.getElementById('suspensionDriverId').value;
                const action = document.getElementById('suspensionAction').value;
                const message = document.getElementById('suspensionMessage').value;
                
                fetch('/api/toggle_suspension', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        driver_id: driverId,
                        action: action,
                        message: message
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Close modal
                        bootstrap.Modal.getInstance(suspensionModal).hide();
                        
                        // Update UI
                        const row = document.getElementById(`driver-row-${driverId}`);
                        const button = row.querySelector('.suspension-btn');
                        
                        if (action === 'suspend') {
                            row.classList.add('suspended-row');
                            button.classList.remove('btn-danger');
                            button.classList.add('btn-success');
                            button.setAttribute('data-action', 'unsuspend');
                            button.innerHTML = '<i class="bi bi-play-fill"></i> Unsuspend';
                        } else {
                            row.classList.remove('suspended-row');
                            button.classList.remove('btn-success');
                            button.classList.add('btn-danger');
                            button.setAttribute('data-action', 'suspend');
                            button.innerHTML = '<i class="bi bi-pause-fill"></i> Suspend';
                        }
                        
                        // Show success message
                        alert(data.message);
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while processing your request.');
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
        const updateButtons = document.querySelectorAll('.update-ref-btn');
        const driverIdInput = document.getElementById('referenceDriverId');
        const modalTitle = document.getElementById('updateReferenceModalLabel');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const capturePhotoBtn = document.getElementById('capturePhotoBtn');
        const saveRefImageBtn = document.getElementById('saveRefImageBtn');
        const webcamElement = document.getElementById('webcam');
        const captureCanvas = document.getElementById('captureCanvas');
        const captureCountdown = document.getElementById('captureCountdown');
        const photoPreview = document.getElementById('photoPreview');
        const imageDataInput = document.getElementById('imageData');
        let stream = null;
        
        updateButtons.forEach(btn => {
          btn.addEventListener('click', function() {
            const driverId = this.getAttribute('data-driver-id');
            const driverName = this.getAttribute('data-driver-name');
            driverIdInput.value = driverId;
            modalTitle.textContent = `Update Photo for ${driverName}`;
            photoPreview.src = "https://placehold.co/600x400.png";
            imageDataInput.value = "";
            capturePhotoBtn.disabled = true;
            saveRefImageBtn.disabled = true;
            // Reset video element and stop previous stream if any
            if (stream) {
              stream.getTracks().forEach(track => track.stop());
              stream = null;
            }
            webcamElement.style.display = 'none';
          });
        });
        
        startCameraBtn.addEventListener('click', async function() {
          try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            webcamElement.srcObject = stream;
            webcamElement.style.display = 'block';
            capturePhotoBtn.disabled = false;
            startCameraBtn.disabled = true;
          } catch (e) {
            alert("Error accessing webcam: " + e.message);
          }
        });
        
        capturePhotoBtn.addEventListener('click', function() {
          // Countdown before capture
          let count = 3;
          captureCountdown.style.display = 'block';
          captureCountdown.textContent = count;
          const interval = setInterval(() => {
            count--;
            if (count === 0) {
              clearInterval(interval);
              captureCountdown.style.display = 'none';
              // Capture current frame
              captureCanvas.width = webcamElement.videoWidth;
              captureCanvas.height = webcamElement.videoHeight;
              captureCanvas.getContext('2d').drawImage(webcamElement, 0, 0);
              const dataURL = captureCanvas.toDataURL('image/jpeg');
              photoPreview.src = dataURL;
              imageDataInput.value = dataURL;
              saveRefImageBtn.disabled = false;
            } else {
              captureCountdown.textContent = count;
            }
          }, 1000);
        });
        
        saveRefImageBtn.addEventListener('click', function() {
          const driverId = driverIdInput.value;
          const imageData = imageDataInput.value;
          if (!imageData) {
            alert("No image captured.");
            return;
          }
          fetch(`/update_reference/${driverId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image_data: imageData })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert("Reference image updated successfully.");
              // Stop stream and reset modal
              if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
              }
              startCameraBtn.disabled = false;
              capturePhotoBtn.disabled = true;
              saveRefImageBtn.disabled = true;
              bootstrap.Modal.getInstance(document.getElementById('updateReferenceModal')).hide();
            } else {
              alert("Error: " + data.error);
            }
          })
          .catch(err => alert("Error: " + err.message));
        });
        
        // When modal is closed, stop webcam if active
        const updateModal = document.getElementById('updateReferenceModal');
        updateModal.addEventListener('hidden.bs.modal', function() {
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
          }
          startCameraBtn.disabled = false;
        });
      });

        // VEHICLE ASSIGNMENT LOGIC
        let vehicles = [];
        // Fetch vehicles for owner
        function fetchVehicles() {
            return fetch('/api/owner_vehicles')
                .then(res => res.json())
                .then(data => {
                    vehicles = data.vehicles || [];
                    // Populate vehicle select dropdown
                    const select = document.getElementById('vehicleSelect');
                    if (select) {
                        select.innerHTML = '<option value="">Select vehicle</option>';
                        vehicles.forEach(v =>
                            select.innerHTML += `<option value="${v.id}">${v.vehicle_name} (${v.license_plate})</option>`
                        );
                    }
                });
        }

        // Assign Vehicle Modal open handler
        document.querySelectorAll('.assign-vehicle-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const driverId = this.getAttribute('data-driver-id');
                document.getElementById('assignDriverId').value = driverId;
                fetchVehicles();
            });
        });

        // Assign Vehicle form submit
        document.getElementById('assignVehicleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/api/assign_vehicle', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Vehicle assigned successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('assignVehicleModal')).hide();
                } else {
                    // Show specific error for overlapping assignments
                    if (data.error && data.error.includes('already assigned')) {
                        alert('Error: ' + data.error);
                    } else {
                        alert('Error: ' + (data.error || 'Failed to assign vehicle'));
                    }
                }
            });
        });

        // Create Vehicle form submit
        document.getElementById('createVehicleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/api/create_vehicle', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Vehicle created!');
                    bootstrap.Modal.getInstance(document.getElementById('createVehicleModal')).hide();
                    fetchVehicles();
                } else {
                    alert('Error: ' + (data.error || 'Failed to create vehicle'));
                }
            });
        });

        // Pie chart for driver activity
        let driverActivityChart;
        function updateDriverActivityPie(activeCount, totalCount) {
            const ctx = document.getElementById('driverActivityPie').getContext('2d');
            const inactiveCount = Math.max(0, totalCount - activeCount);
            // Update number labels
            document.getElementById('activeCountLabel').textContent = activeCount;
            document.getElementById('inactiveCountLabel').textContent = inactiveCount;
            const data = {
                labels: ['Active', 'Inactive'],
                datasets: [{
                    data: [activeCount, inactiveCount],
                    backgroundColor: ['#198754', '#adb5bd'],
                    borderWidth: 1
                }]
            };
            if (driverActivityChart) {
                driverActivityChart.data.datasets[0].data = [activeCount, inactiveCount];
                driverActivityChart.update();
            } else {
                driverActivityChart = new Chart(ctx, {
                    type: 'pie',
                    data: data,
                    options: {
                        responsive: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>
